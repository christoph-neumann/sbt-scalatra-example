import sbt._
import Keys._

object SbtTestBuild extends Build {
	lazy val root = Project("root", file(".")) settings(
		// Do not include the scala version or the project version in the artifact name
		artifactName := { (config: String, module: ModuleID, artifact: Artifact) =>
			artifact.name + "." + artifact.extension
		},

		// Make sure the jars are in the exported classpath instead of class directories
		exportJars := true,

		// Custom tasks
		cleanAll <<= cleanAllTask,
		cleanAll <<= cleanAll.dependsOn(clean in Compile),
		dist <<= distTask,
		dist <<= dist.dependsOn(packageBin in Compile)
	)

	val cleanAll = TaskKey[Unit]("clean-all", "Removes all autogenerated files.")
	def cleanAllTask = (streams, baseDirectory) map {
		(out, basedir) => {
			IO.delete(basedir / "project" / "boot")
			IO.delete(basedir / "project" / "target")
			IO.delete(basedir / "target")
		}
	}

	val dist = TaskKey[Unit]("dist", "Produce a distribution.")
	def distTask = (streams, baseDirectory, fullClasspath in Runtime) map {
		(out, basedir, deps) => {
			val dist = new File(basedir, "target/dist")
			val lib = new File(dist, "lib")

			// Copy the whole web tree.
			val dist_web = new File(dist, "web")
			dist_web.mkdir
			IO.copyDirectory(new File(basedir, "src/main/web"), dist_web)

			// Copy everything in the scripts directory and make all the shell scripts executable.
			IO.copyDirectory(new File(basedir, "src/main/scripts"), dist)
			for ( file <- dist.listFiles; if (file.isFile && file.name.endsWith("sh")) ) yield {
				file.setExecutable(true)
			}

			// Copy all the dependencies into the "lib" directory.
			deps.map(_.data) foreach { file =>
				out.log.info("Copying "+ file.getName)
				IO.copyFile(file, new File(lib, file.getName))
			}
		}
	}
}
